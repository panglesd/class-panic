<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>title</title>
    <link rel="stylesheet" href="/stylesheets/style.css">
<!--    <script src="script.js"></script>-->
  </head>
  <body>
      <div id="answerContainer">
	  <div id="question"></div>
	  <div class="reponse" id="rep0"></div>
	  <div class="reponse" id="rep1"></div>
	  <div class="reponse" id="rep2"></div>
	  <div class="reponse" id="rep3"></div>
	  <div id="leave"><a href="main.php">Quitter la salle</a></div>
      </div>
      <div id="controlPanel">
	  <div class="controlPanel" id="reveal">Réveler</div>
	  <div class="controlPanel" id="nextQuestion">Passer à la question suivante</div>
	  <!--	      <div class="controlPanel" id="choose">La prochaine question sera</div>-->
	  <ul id="chooseSet">
	      <li id="chooseQuestion"> Choisir le set de questions :</li>
	      
	      <div class="select">
		  <select name="setQuestion" onchange="setUpdate()" id="setChosen">
		      <option> </option>
		      <% setOwnedList.forEach(function(set) { %>
			  <option <%= set.id == room.questionSet ? "selected" : "" %>> <%= set.name %></option>
			  <% }); %>
		  </select>
	      </div>
	  </ul>
	  <ul id="chooseQFromSet">
	    <li id="chooseQuestionNext"> Choisir la question suivante :</li>
	    
	    <% i = set.firstQ ;
	       do { %>
	    <li onclick="setNextQuestionId(this)" id="q<%= set.lQuestion[i].id %>" class="<%= i==room.id_currentQuestion ? "currentQuestion" : (i==set.lQuestion[room.id_currentQuestion].nextQuestion ? "nextQuestion" : "") %>">
	      <%= set.lQuestion[i].enonce %>
	      <%  i = set.lQuestion[i].nextQuestion %>
	    </li>
	    <% } while (i != set.firstQ) %>
	  </ul>
	  <div class="controlPanel" id="stats">
	    <ul>
	      <li style="font-family: Impact, 'Arial Black', Arial, Verdana, sans-serif;"> Ce qu'en disent les élèves : </li>
	      <li> <div style="display:flex; justify-content: space-between;color:green;"> Georges : <div style="color:green;">3</div></div></li>
	      <li> <div style="display:flex; justify-content: space-between;color:red;"> Barmpalias : <font color="red">0</font></div></li>
	      <li> <div style="display:flex; justify-content: space-between;color:white;"> Albert : <font color="">2</font></div></li>
	    </ul>
	  </div>
      </div>
      <div id="nbVoters"> </div>
      <script src="/socket.io/socket.io.js"></script>
      <script>
	var socket = io.connect('http://localhost:3000/');
	var socketAdmin = io.connect('http://localhost:3000/admin');
	
	     /*********************************************************************/
	     /*                 Actions à effectuer à toute connection            */
	     /*********************************************************************/
	
	// On informe le serveur dans quel room on est
	socket.on('connect', () => {
    	    socket.emit("chooseRoom", "Math");
	});
	socketAdmin.on('connect', () => {
	    socketAdmin.emit("chooseRoom", "Math");
	});

	/*******************************************************************************/
	/*******************************************************************************/
	/*                 Partie propre aux admins                                    */
	/*******************************************************************************/

    	     /*********************************************************************/
	     /*                 lorsque l'on veut changer de question             */
	     /*********************************************************************/

	function changeQuestionPlease() {
	    socketAdmin.emit("changeQuestionPlease");
	}

    	     /*********************************************************************/
	     /*                 lorsque l'on veut reveler les resultats           */
	     /*********************************************************************/

	function revealResults() {
	    socketAdmin.emit("revealResults");
	}

    	     /*********************************************************************/
	     /*                 lorsque l'on reçoit les nouvelles statistiques    */
	     /*********************************************************************/

	socketAdmin.on('newStats', function (newStats) {
	    console.log(newStats);
	    // TO BE IMPLEMENTED
	});

	
	/*******************************************************************************/
	/*******************************************************************************/
	/*                 Partie commune aux eleves et aux admins                     */
	/*******************************************************************************/
	
    	     /*********************************************************************/
	     /*                 lorsque l'on reçoit une nouvelle question         */
	     /*********************************************************************/
	
	socket.on('newQuestion', function (reponse) {
	    console.log(reponse);
	    document.querySelectorAll(".reponse").forEach(function (value) {
		value.classList.remove("selected");
		value.classList.add("notSelected");
	    });
	    document.querySelectorAll(".reponse").forEach(function (e) {
		e.style.boxShadow="";
		//	   e.style.backgroundColor="#F5F5DC";
		e.style.background = "linear-gradient(to right, rgba(0,0,0,0) 0%,#F5F5DC 0%)";
	    });
	    document.querySelector("li.currentQuestion").classList.remove("currentQuestion");
	    document.querySelector("li.nextQuestion").classList.remove("nextQuestion");
	    document.querySelector("li#q"+reponse.id).classList.add("currentQuestion");
	    document.querySelector("li#q"+reponse.nextQuestion).classList.add("nextQuestion");
	    document.querySelector("#question").innerHTML=reponse.enonce;
	    document.querySelector("#rep0").innerHTML=reponse.reponse1;
	    document.querySelector("#rep1").innerHTML=reponse.reponse2;
	    document.querySelector("#rep2").innerHTML=reponse.reponse3;
	    document.querySelector("#rep3").innerHTML=reponse.reponse4;
	});
	
	     /*********************************************************************/
	     /*                 lorsque l'on reçoit la correction                 */
	     /*********************************************************************/
	
	socket.on('correction', function (correction) {
	    console.log(correction);
	    document.querySelectorAll(".reponse").forEach(function (elem) {elem.style.boxShadow="0 0 8px 10px red"});
	    //	      document.querySelector("#rep"+correction.correct).style.boxShadow="0 0 8px 15px green";
	    document.querySelector("#rep"+"1").style.boxShadow="0 0 8px 15px green";
	    var total = 0;
	    correction.forEach(function (v) { total += v.count });
	    total=Math.max(total,1);
	    correction.forEach(function (v) {
		document.querySelector("#rep"+v.answer).style.background =
		    "linear-gradient(to right, rgba(0,0,0,0.5) "+((0.+v.count)/total*100.-5)+"%,#F5F5DC "+((0.+v.count)/total*100.)+"%)";
	    });
	});
	
	     /*********************************************************************/
	     /*                 pour redemander d'envoyer la question             */
	     /*********************************************************************/
	
	function sendQuestionPlease() {
	    socket.emit("sendQuestionPlease");
	}
	
	     /*********************************************************************/
	     /*                 pour envoyer son choix de reponse                 */
	     /*********************************************************************/
	
	function chooseAnswer(i) {
	    socket.emit("chosenAnswer", i);
	}
	     /*********************************************************************/
	     /*                 Mise en place des event listeners                 */
	     /*********************************************************************/
	
	document.querySelector("#reveal").addEventListener("click", revealResults);
	document.querySelector("#nextQuestion").addEventListener("click", changeQuestionPlease);
	
      </script>
  </body>
</html>
