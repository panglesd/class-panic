<%- include('admin_header', {active:"salles"}); -%>
<link href="https://unpkg.com/tabulator-tables@4.0.4/dist/css/tabulator.min.css" rel="stylesheet">
<script type="text/javascript" src="https://unpkg.com/tabulator-tables@4.0.4/dist/js/tabulator.min.js"></script>
<style>
 p {
     margin:10px;
 }
</style>
<h2> Statistiques </h2>
<form id="statsForm">
    <fieldset>
	<p>
	    <label>
		Numéro d'étudiant : <br/>
		<input id="studentNumber" name="studentNumber" type="text"/>
	    </label>
	</p>
	<p>
	    <label>
		Nom : <br/>
		<input id="studentName" name="studentName" type="text"/>
	    </label>
	</p>
	<p>
	    Cours :<br/>
	    <select  id="courseID" name="courseID">
		<option value ="">Tous les cours</option>
		<% courseOwnedList.forEach(function(course) { %>
		<option value="<%=course.id%>"><%= course.name %></option>
		<% }); %>
	    </select>
	</p>
	<p>
	    Salle :<br/>
	    <select  id="roomID" name="roomID">
		<option value ="">Toutes les salles</option>
		<% roomOwnedList.forEach(function(room) { %>
		<option value="<%=room.id%>"><%= room.name %></option>
		<% }); %>
	    </select>
	</p>
	<p>
	    Set :<br/>
	    <select  id="setID" name="setID">
		<option value ="">Tous les sets</option>
		<% setOwnedList.forEach(function(sett) { %>
		<option value="<%= sett.id%>"><%= sett.name %></option>
		<% }); %>
	    </select><br/>
	</p>
	<p>
	    Question :<br/>
	    <select id="questionID" name="questionID">
		<option value ="">Toutes les questions</option>
		<% questionOwnedList.forEach(function(question) { %>
		<option value="<%= question.id%>"><%= question.enonce %></option>
		<% }); %>
	    </select><br/>
	</p>
	<p>
	    Survenu entre <input name="dateBegin" id="dateBegin" type="date"/> et <input name="dateEnd" id="dateEnd" type="date"/><br/>
	</p>
    </fieldset>
</form>
<div id="wrapper-stats">
</div>
<script src="/socket.io/socket.io.js"></script>
<script>
 var server = "<%= server %>";
</script>
<script>
 
 var socketStats = io.connect(server+'/stats');
 questions = <%- JSON.stringify(questionOwnedList) %>;
 courses = <%- JSON.stringify(courseOwnedList) %>;
 sets = <%- JSON.stringify(setOwnedList) %>;
 rooms = <%- JSON.stringify(roomOwnedList) %>;

 function update() {
     filter = {};

     list = ["studentNumber",
	     "studentName",
	     "courseID",
	     "roomID",
	     "setID",
	     "questionID",
	     "dateBegin",
	     "dateEnd"];

     list.forEach(function (cond) {
//	 console.log(cond);
	 window[cond] = document.querySelector("#"+cond);
	 console.log(window[cond]);
	 console.log(window[cond].value);
	 if(window[cond].value)
	     filter[cond] = window[cond].value
     });
     socketStats.emit("stats", filter);
     
     console.log("filter", filter);
/*
     studentName = document.querySelector("#studentName");
     courseID = document.querySelector("#courseID");
     roomID = document.querySelector("#roomID");
     setID = document.querySelector("#setID");
     questionID = document.querySelector("#questionID");

     if(studentNumber.value >= 0)
	 filter.studentNumber = studentNumber.value;
     if(studentName.value >= 0)
	 filter.studentName = studentName.value;
     if(courseID.value >= 0)
	 filter.studentNumber = studentNumber.value;
     if(studentNumber.value >= 0)
	 filter.studentNumber = studentNumber.value;
  */   
 }

 socketStats.on("newStats", (filter, res) => {
     console.log("on a reçu :", filter, res);
     wrapper = document.querySelector("#wrapper-stats");
     wrapper.innerHTML = "<table>";
     res.forEach((data) => {
	 data.enonce = JSON.parse(data.customQuestion).enonce
     });
     /*
     res.forEach((data) => {
	 wrapper.innerHTML += "<tr>"+
			      '<td>' + data.blocID + '</td>' +
			      '<td>' + data.correct + '</td>' +
			      '<td>' + data.courseID + '</td>' +
			      '<td>' + JSON.parse(data.customQuestion).enonce + '</td>' +
			      '<td>' + data.fullName + '</td>' +
			      '<td>' + data.questionID + '</td>' +
			      '<td>' + data.roomID + '</td>' +
			      '<td>' + data.studentNumber + '</td>' +
			      '<td>' + data.time + '</td>' +
			      '</tr>';
     });
*/
     var table = new Tabulator("#wrapper-stats", {
//	 layout:"fitColumns", //fit columns to width of table (optional)
	 columns:[ //Define Table Columns
		   {title:"Eleve", field:"fullName"},
		   {title:"Enonce", field:"enonce"},
		   {title:"Justesse", field:"correct"},
		   {title:"Instance de Question", field:"blocID"},
		   {title:"Question", field:"questionID"},
		   {title:"Cours", field:"courseID"},
		   {title:"Salle", field:"roomID"},
		   {title:"Date", field:"time"}
	 ]
     });
     table.setData(res);
     
 });

 document.querySelector("#statsForm").addEventListener('change', (ev) => {
     update();
 });
 
</script>

<%- include('admin_footer'); -%>
